#!/usr/bin/env bash
set -e

OUT=tests/test_vectors/full_suite
mkdir -p "$OUT"

gen () {
  RULE=$1
  TYPE=$2
  CONTENT=$3

  cat > "$OUT/$RULE.json" <<EOF
{
  "files": [
    {
      "name": "test.$TYPE",
      "type": "$TYPE",
      "content": "$CONTENT"
    }
  ],
  "expect": {
    "rule_id": "$RULE",
    "count": 1
  }
}
EOF
}

# ---------- IRR-IDENT ----------
gen IRR-IDENT-01 terraform "resource \"aws_iam_user\" \"u\" {}"
gen IRR-IDENT-02 terraform "resource \"aws_iam_access_key\" \"k\" {}"
gen IRR-IDENT-03 kubernetes "kind: ServiceAccount\nmetadata:\n  name: default"
gen IRR-IDENT-04 terraform "resource \"aws_iam_role\" \"r\" {}"
gen IRR-IDENT-05 terraform "resource \"aws_iam_policy\" \"p\" {}"
gen IRR-IDENT-06 cloudformation "Type: AWS::IAM::User"
gen IRR-IDENT-07 arm "{ \"type\": \"Microsoft.Authorization/roleAssignments\" }"
gen IRR-IDENT-08 terraform "resource \"aws_iam_group\" \"g\" {}"

# ---------- IRR-DEC ----------
gen IRR-DEC-01 terraform "resource \"aws_db_instance\" \"db\" {}"
gen IRR-DEC-02 terraform "resource \"aws_s3_bucket\" \"b\" { lifecycle { prevent_destroy = true } }"
gen IRR-DEC-03 terraform "resource \"aws_launch_template\" \"lt\" {}"
gen IRR-DEC-04 terraform "resource \"aws_autoscaling_group\" \"asg\" {}"
gen IRR-DEC-05 terraform "resource \"aws_kms_key\" \"k\" {}"
gen IRR-DEC-06 terraform "resource \"aws_efs_file_system\" \"fs\" {}"
gen IRR-DEC-07 terraform "resource \"aws_rds_cluster\" \"c\" {}"
gen IRR-DEC-08 terraform "resource \"aws_lb\" \"lb\" {}"
gen IRR-DEC-09 terraform "resource \"aws_eks_cluster\" \"eks\" {}"
gen IRR-DEC-10 terraform "resource \"aws_vpc\" \"vpc\" {}"

# ---------- ADMIN ----------
gen ADMIN-01 terraform "resource \"aws_iam_policy_attachment\" \"a\" {}"
gen ADMIN-02 kubernetes "kind: ClusterRoleBinding"
gen ADMIN-03 terraform "resource \"aws_iam_role_policy_attachment\" \"a\" {}"
gen ADMIN-04 terraform "resource \"aws_iam_group_policy_attachment\" \"a\" {}"
gen ADMIN-05 terraform "resource \"aws_iam_user_policy_attachment\" \"a\" {}"
gen ADMIN-06 cloudformation "Type: AWS::IAM::Policy"
gen ADMIN-07 arm "{ \"type\": \"Microsoft.Authorization/policyAssignments\" }"

echo "Generated $(ls $OUT | wc -l) test vectors"

